## 简介
本文档介绍 Environment 的高级能力，包括注册中心集成、流式响应、环境上下文、Agent 运行支持、工具管理等功能。这些功能可以帮助你更好地管理和扩展 Environment 的能力。

如果你刚开始使用 Environment，建议先阅读《环境客户端》文档了解基础使用方法。

---

## 注册中心集成
### 本地注册中心
```python
# 使用本地 JSON 文件作为注册中心（Builder 模式）
sandbox = Sandbox().tools(["tool1", "tool2"]).registry_url("~/workspace/registry.json").build()

# 注册中心文件格式
{
    "tool:server_name": {
        "entity_type": "tool",
        "name": "server_name",
        "description": "服务器描述",
        "tools": [
            {
                "name": "tool_name",
                "description": "工具描述"
            }
        ],
        "data": { 
            "type": "streamable-http",
            "url": "https://...",
            "headers": {...}
        }
    }
}
```

### 远程注册中心
```python
# 使用远程注册中心（Builder 模式）
sandbox = Sandbox().tools(["tool1", "tool2"]).registry_url("https://registry.example.com").build()

# 注册中心 API
# POST /api/v1/registry/search
{
    "entity_type": "tool",
    "status": "active",
    "tools": ["tool1", "tool2"]  # 可选
}
```

---

## 流式响应
流式响应功能支持工具结果的实时返回，包括进度回调。这对于长时间运行的工具非常有用。

```python
# 启用流式响应（Builder 模式）
sandbox = Sandbox().mcp_config({...}).streaming(True).build()

# 工具调用时，进度消息会自动发送到事件总线
result = await sandbox.call_tool(action_list=[{
    "tool_name": "server_name",
    "action_name": "long_running_tool",
    "params": {}
}])

# 进度消息格式
# Message(
#     category=Constants.OUTPUT,
#     payload=Output(data="进度信息"),
#     sender="server_name__tool_name"
# )
```

---

## 环境上下文能力
环境上下文功能允许你定义上下文参数，这些参数会自动注入到工具调用中。这对于传递用户信息、环境配置等非常有用。

```python
# 设置环境上下文（Builder 模式）
sandbox = Sandbox().mcp_config({...}).env_content({
    "user_id": "user123",
    "workspace": "/path/to/workspace",
    "custom_config": {"key": "value"}
}).env_content_name("env_content").build()  # env_content_name 可选，默认为 "env_content"

# 工具调用时，env_content 参数会自动注入
# 同时还会自动添加 task_id、session_id、agent_id 等动态上下文
result = await sandbox.call_tool(
    action_list=[{
        "tool_name": "server_name",
        "action_name": "tool_name",
        "params": {
            # env_content 会自动注入，无需手动传递
            # 最终参数会包含：
            # {
            #     "user_id": "user123",
            #     "workspace": "/path/to/workspace",
            #     "custom_config": {"key": "value"},
            #     "task_id": "...",  # 从 context 自动添加
            #     "session_id": "...",  # 从 context 自动添加
            #     "agent_id": "..."  # 从 event_message 自动添加
            # }
        }
    }],
    context=context  # 传入 context 以自动添加 task_id 和 session_id
)
```

**工作原理**：
1. 环境上下文参数在工具 schema 中会被隐藏（LLM 看不到）
2. 工具调用时自动注入用户定义的值
3. 动态添加 `task_id`、`session_id`、`agent_id` 等上下文信息
4. 如果用户手动提供了参数值，用户值优先

---

## Agent 运行支持
支持将 Agent 配置在 Environment 环境中运行，使 Agent 可以作为工具被其他 Agent 调用。

### 本地 Agent
```python
# 简单格式：直接指定 Agent 目录路径（Builder 模式）
sandbox = Sandbox().mcp_config({...}).agents({
    "local_agent": "/path/to/agents"  # Agent 目录路径
}).build()

# 扩展格式：提供更多配置选项（Builder 模式）
sandbox = Sandbox().mcp_config({...}).agents({
    "advanced_agent": {
        "location": "/path/to/agents",
        "run_mode": "local",  # 可选："local" 或 "remote"，默认 "local"
        "env": {"KEY": "value"},  # 可选：环境变量
        "cwd": "/path/to/workdir",  # 可选：工作目录
        "headers": {
            "SANDBOX_ENV": '{"key": "value"}'  # 可选：通过 headers 传递环境变量（JSON 字符串）
        }
    }
}).build()

# 使用链式 Builder API 配置 Agent
sandbox = (Sandbox()
    .mcp_config({...})
    .agents()
    .advanced_agent()
    .location("/path/to/agents")
    .run_mode("local")
    .env({"KEY": "value"})
    .build()
)
```

### 远程 Agent
```python
import os

# 设置环境变量（远程 Agent 必需）
os.environ["CUSTOM_ENV_URL"] = "https://custom.example.com"
os.environ["CUSTOM_ENV_TOKEN"] = "your_token"
os.environ["CUSTOM_ENV_IMAGE_VERSION"] = "v1.0.0"

# 简单格式：直接指定远程 URL（Builder 模式）
sandbox = Sandbox().mcp_config({...}).agents({
    "remote_agent": "https://github.com/user/repo.git"  # Git 仓库 URL
}).build()

# 扩展格式：提供更多配置选项（Builder 模式）
sandbox = Sandbox().mcp_config({...}).agents({
    "remote_agent": {
        "location": "https://github.com/user/repo.git",
        "run_mode": "remote",  # 明确指定为远程模式
        "repo_url": "https://github.com/user/repo.git",  # 可选：如果 location 不是 URL
        "project_path": "subdir",  # 可选：项目子目录
        "env": {"KEY": "value"},  # 可选：环境变量
        "headers": {"Custom-Header": "value"}  # 可选：自定义 HTTP 头部
    }
}).build()
```

**注意事项**：
- 本地 Agent 使用 `aworld-cli serve --mcp --agent-dir` 命令启动
- 远程 Agent 需要设置 `CUSTOM_ENV_URL`、`CUSTOM_ENV_TOKEN`、`CUSTOM_ENV_IMAGE_VERSION` 环境变量
- Agent 配置会自动转换为 MCP 服务器配置并合并到 `mcp_config` 中

---

## 自定义环境工具
```python
import os

# 设置环境变量
os.environ["CUSTOM_ENV_URL"] = "https://custom.example.com"
os.environ["CUSTOM_ENV_TOKEN"] = "your_token"
os.environ["CUSTOM_ENV_IMAGE_VERSION"] = "v1.0.0"

# 使用自定义环境工具（Builder 模式）
sandbox = Sandbox().custom_env_tools({
    "custom_server": {
        "type": "streamable-http",
        "url": "...",
        "headers": {...}
    }
}).build()
```

---

## 黑名单工具
```python
# 禁用特定工具（Builder 模式）
sandbox = Sandbox().mcp_config({
    "mcpServers": {
        "server_name": {...}
    }
}).black_tool_actions({
    "server_name": ["tool1", "tool2"]  # 禁用这些工具
}).build()
```

---

## 技能配置
```python
# 配置技能系统（Builder 模式）
sandbox = Sandbox().mcp_config({
    "mcpServers": {
        "server_name": {...}
    }
}).skill_configs({
    "skill1": {
        "tools": ["tool1", "tool2"],
        "description": "技能描述"
    }
}).build()
```

---

## 工具注册
### 注册到远程注册中心
```python
from aworld.sandbox import Sandbox

result = await Sandbox.register(
    registry_url="https://registry.example.com",
    name="my-server",
    version="1.0.0",
    description="我的服务器描述",
    data={
        "type": "streamable-http",
        "url": "https://...",
        "headers": {...}
    },
    tools=[
        {
            "name": "tool_name",
            "description": "工具描述"
        }
    ],
    token="your_registry_token"
)

# 返回结果
# {
#     "success": True,
#     "entity_id": "...",
#     "message": "Successfully registered my-server"
# }
```

### 注册到本地文件
```python
result = await Sandbox.register(
    registry_url="~/workspace/registry.json",
    servers={
        "mcpServers": {
            "server_name": {
                "type": "streamable-http",
                "url": "https://...",
                "headers": {...}
            }
        }
    }
)

# 返回结果
# {
#     "success": True,
#     "file_path": "/path/to/registry.json",
#     "message": "Successfully registered 1 server(s) to local file",
#     "registered_count": 1
# }
```

