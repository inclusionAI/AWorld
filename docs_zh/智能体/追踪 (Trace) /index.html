
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/inclusionAI/AWorld/docs_zh/%E6%99%BA%E8%83%BD%E4%BD%93/%E8%BF%BD%E8%B8%AA%20%28Trace%29%20/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../../imgs/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
      
        <title>追踪 (Trace) - AWorld (Agent World) harness</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/aworld.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="AWorld (Agent World) harness" class="md-header__button md-logo" aria-label="AWorld (Agent World) harness" data-md-component="logo">
      
  <img src="../../../imgs/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AWorld (Agent World) harness
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              追踪 (Trace) 
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-purple"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="deep-purple"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/inclusionAI/AWorld" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    inclusionAI/AWorld
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../Get%20Start/Overview/" class="md-tabs__link">
          
  
  
  Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../Agents/Build%20Agent/" class="md-tabs__link">
          
  
  
  Agents

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../Environment/Overview/" class="md-tabs__link">
          
  
  
  Environment

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../Training/Trainer/" class="md-tabs__link">
          
  
  
  Training

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../Deployment/OceanBase/" class="md-tabs__link">
          
  
  
  Deployment

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="AWorld (Agent World) harness" class="md-nav__button md-logo" aria-label="AWorld (Agent World) harness" data-md-component="logo">
      
  <img src="../../../imgs/logo.png" alt="logo">

    </a>
    AWorld (Agent World) harness
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/inclusionAI/AWorld" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    inclusionAI/AWorld
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Get%20Start/Overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Get%20Start/Quick%20Start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Get%20Start/Core%20Capabilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Core Capabilities
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Get%20Start/Parallel%20Tasks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Parallel Tasks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Get%20Start/Streaming%20Response/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Streaming Response
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Get%20Start/HITL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Human in the Loop (HITL)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Agents
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Agents
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Agents/Build%20Agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Build Agent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Agents/Build%20Multi-Agent%20System%28MAS%29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Agent System(MAS)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Agents/Build%20WorkFlow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Agents/Custom%20Agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custom Agent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Agents/Context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Context
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Runtime
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Runtime
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Agents/Runtime/Overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Agents/Runtime/Custom%20Runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custom Runner
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Agents/Runtime/Hooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hooks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Agents/Memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Memory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Agents/Trace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Trace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Environment
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Environment
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Environment/Overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Environment/Using%20API/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Using API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Environment/Env%20Client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Env Client
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Environment/Advanced%20Capabilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Advanced Capabilities
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Training
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Training
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Training/Trainer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Trainer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Training/Trajectory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Trajectory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Training/Evaluation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Evaluation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Deployment
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Deployment/OceanBase/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Oceanbase
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        总览
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="总览">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        核心特性
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        主要组件
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        快速开始
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="快速开始">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trace" class="md-nav__link">
    <span class="md-ellipsis">
      
        配置启用 Trace
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trace-ui-server-trace" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用内置 Trace UI Server 查看 Trace
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trace-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        Trace UI 信息解读
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        核心概念
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trace_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Trace（追踪）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#span" class="md-nav__link">
    <span class="md-ellipsis">
      
        Span（跨度）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracecontext" class="md-nav__link">
    <span class="md-ellipsis">
      
        TraceContext（追踪上下文）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traceprovider" class="md-nav__link">
    <span class="md-ellipsis">
      
        TraceProvider（追踪提供者）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracer（追踪器）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spanconsumer" class="md-nav__link">
    <span class="md-ellipsis">
      
        SpanConsumer（跨度消费者）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpanConsumer（跨度消费者）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用方式
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instrumentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Instrumentation（插桩）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Instrumentation（插桩）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        启用方式
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        集成三方观测平台
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="集成三方观测平台">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用三方商用平台
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="使用三方商用平台">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logfire" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用 Logfire
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用三方开源平台
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="使用三方开源平台">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jaeger" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用 Jaeger
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trace_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        如何自定义 Trace 记录
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="如何自定义 Trace 记录">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#span_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用上下文管理器创建 Span
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#span_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        装饰器方式创建 Span
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#span_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        获取当前 Span 并添加属性
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#span_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        手动管理 Span 生命周期
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        高级功能
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="高级功能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        自动追踪配置
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trace_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Trace命名空间隔离
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trace_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        集成其他Trace传播协议
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="集成其他Trace传播协议">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        核心概念
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      
        传播协议集成架构
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      
        实现自定义传播协议
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/inclusionAI/AWorld/tree/main/docs/docs_zh/智能体/追踪 (Trace) .md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


  <h1>追踪 (Trace) </h1>

<h2 id="_1">总览</h2>
<p>AWorld Trace 模块是一个基于 OpenTelemetry 构建的全功能分布式追踪系统，为 AWorld 框架提供完整的可观测性能力。该模块提供了灵活的追踪配置、自动插桩和手动追踪能力，支持多种后端存储和导出方式。</p>
<h3 id="_2">核心特性</h3>
<ul>
<li>基于 OpenTelemetry 标准实现，支持与主流可观测性平台兼容</li>
<li>提供自动插桩功能，无需修改代码即可追踪关键组件（Agent、Tool、LLM等）</li>
<li>支持手动创建和管理追踪 Span，实现精细化追踪</li>
<li>内置内存存储和 Trace UI Server，方便快速查看追踪数据</li>
<li>支持与第三方可观测性平台（如 Logfire、Jaeger）集成</li>
<li>提供灵活的配置选项，满足不同场景需求</li>
</ul>
<h3 id="_3">主要组件</h3>
<ul>
<li>TraceManager ：核心追踪管理器，负责创建和管理追踪 Span</li>
<li>ContextManager ：上下文管理器，处理追踪上下文的传播</li>
<li>Instrumentation ：自动插桩组件，对框架核心组件进行追踪</li>
<li>OpenTelemetryAdapter ：OpenTelemetry 适配器，实现与 OpenTelemetry API 的桥接</li>
<li>TraceServer ：内置追踪 UI 服务器，提供可视化追踪数据查看能力</li>
</ul>
<h2 id="_4">快速开始</h2>
<h3 id="trace">配置启用 Trace</h3>
<p>要在 AWorld 项目中启用 Trace 记录，您需要在项目启动时配置 ObservabilityConfig：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aworld.trace.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">configure</span><span class="p">,</span> <span class="n">ObservabilityConfig</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="c1"># 配置 Trace</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="n">config</span> <span class="o">=</span> <span class="n">ObservabilityConfig</span><span class="p">(</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">trace_provider</span><span class="o">=</span><span class="s2">&quot;otlp&quot;</span><span class="p">,</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">trace_backends</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;memory&quot;</span><span class="p">],</span>  <span class="c1"># 使用内存存储</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">trace_server_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 启用内置 Trace UI Server</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">trace_server_port</span><span class="o">=</span><span class="mi">7079</span>       <span class="c1"># Trace UI Server 端口</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="p">)</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="c1"># 应用配置</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="trace-ui-server-trace">使用内置 Trace UI Server 查看 Trace</h3>
<p>启用 Trace UI Server 后，您可以通过浏览器访问以下地址查看追踪数据：<a href="http://localhost:7079">http://localhost:7079</a></p>
<p>Trace UI 提供了以下功能：</p>
<ul>
<li>查看所有追踪记录列表</li>
<li>查看单个追踪的完整调用链路</li>
<li>查看每个 Span 的详细信息，包括属性、状态和持续时间</li>
<li>支持按时间排序和筛选追踪记录</li>
</ul>
<h3 id="trace-ui">Trace UI 信息解读</h3>
<p><img alt="" src="../../../imgs/trace_ui.png" /></p>
<p>AWorld 框架在运行过程中会自动创建多个核心 Span，用于追踪框架各个组件的执行情况。以下是主要的核心 Span 类型：</p>
<ul>
<li>Event Span<ul>
<li>名称格式：event.<event类型></li>
<li>描述：AWorld 是以event驱动的运行框架，Trace系统默认会为各个Event的执行创建一个Span，Span名称以“event.”为前缀，“event.”后面的二级名称为event类型，如:event.output，代表一条output事件</li>
<li>主要属性：<ul>
<li>event.topic：事件主题</li>
<li>event.payload：事件详情</li>
<li>event.sender：事件发送者</li>
<li>event.receiver：事件接收者</li>
</ul>
</li>
</ul>
</li>
<li>Task Span<ul>
<li>名称格式：task.<session_id></li>
<li>描述：代表一个完整的任务执行过程</li>
<li>主要属性：<ul>
<li>task.id：任务id</li>
<li>task.input：用户输入</li>
<li>task.is_sub_task：是否为子任务</li>
</ul>
</li>
</ul>
</li>
<li>Agent Span<ul>
<li>名称格式：agent.<agent名称></li>
<li>描述：代表一个agent的执行过程</li>
<li>主要属性：<ul>
<li>agent.name ：agent名称</li>
<li>agent.id ：agent ID</li>
<li>session.id: session ID</li>
<li>user.id: 用户 ID</li>
</ul>
</li>
</ul>
</li>
<li>Tool Span<ul>
<li>名称格式：tool.&lt;工具名称&gt;</li>
<li>描述：代表一个工具的执行过程，如果是mcp工具，&lt;工具名称&gt;为mcp服务的名称</li>
<li>主要属性<ul>
<li>tool.name：工具名称</li>
<li>agent.name ：调用工具的agent名称</li>
<li>agent.id ：调用工具的agent ID</li>
<li>ession.id: session ID</li>
<li>user.id: 用户 ID</li>
</ul>
</li>
<li>如何查看工具执行结果<ul>
<li>查看子span中的“event.output.tool_call_result”span</li>
</ul>
</li>
</ul>
</li>
<li>LLM Span<ul>
<li>名称格式：llm.&lt;模型名称&gt;</li>
<li>描述：代表一次LLM调用过程</li>
<li>主要属性<ul>
<li>gen_ai.prompt：调用LLM的提示词</li>
<li>gen_ai.prompt.tools：调用LLM的可用工具列表</li>
<li>gen_ai.request.&lt;参数名&gt;：调用LLM时的请求参数，如：gen_ai.request.top_k</li>
<li>gen_ai.completion.content：LLM完成响应内容</li>
<li>gen_ai.duration：LLM完成响应时间</li>
<li>gen_ai.completion.reasoning_content：LLM推理内容</li>
<li>gen_ai.completion.tool_calls：LLM返回的工具调用指令</li>
<li>gen_ai.first_token_duration：LLM返回的首token时间</li>
<li>gen_ai.usage.input_tokens：LLM调用的输入token使用量</li>
<li>gen_ai.usage.output_tokens：LLM调用的输出token使用量</li>
<li>gen_ai.usage.total_tokens：LLM调用的token总使用量</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="_5">核心概念</h2>
<h3 id="trace_1">Trace（追踪）</h3>
<p>Trace 是一个完整的调用链路，由多个 Span 组成，代表了一个完整的操作流程。每个 Trace 都有一个唯一的 Trace ID，用于标识整个调用链路。在AWorld中，默认情况下，一个Trace代表用户请求的一个Task执行过程。</p>
<h3 id="span">Span（跨度）</h3>
<p>Span 是 Trace 中的单个操作单元，代表了一个具体的执行步骤。每个 Span 都有一个唯一的 Span ID，包含以下信息：</p>
<ul>
<li>名称：操作的名称</li>
<li>开始时间和结束时间：操作的执行时间范围</li>
<li>持续时间：操作执行的总时长</li>
<li>属性：与操作相关的键值对信息</li>
<li>状态：操作的执行状态（成功、失败等）</li>
<li>父 Span ID：父操作的 Span ID</li>
<li>子 Span 列表：当前操作的子操作列表</li>
</ul>
<h3 id="tracecontext">TraceContext（追踪上下文）</h3>
<p>TraceContext 是跨服务传递追踪信息的载体，包含 Trace ID、Span ID 等信息，用于在分布式环境中关联不同服务的 Span。</p>
<h3 id="traceprovider">TraceProvider（追踪提供者）</h3>
<p>TraceProvider 是创建和管理 Tracer 的工厂，负责配置和初始化追踪系统。AWorld对Trace操作实现了高层抽象，使AWorld其他各功能模块对Trace的使用不依赖于某个具体的Trace实现框架，不同的三方Trace框架可以提供各自的TraceProvider接入（默认实现了Opentelemetry框架）。</p>
<h3 id="tracer">Tracer（追踪器）</h3>
<p>Tracer 是创建和管理 Span 的组件，用于在应用代码中创建和结束 Span。</p>
<h3 id="spanconsumer">SpanConsumer（跨度消费者）</h3>
<p>SpanConsumer 是消费 Span 数据的组件，可以帮助用户实现对Spen数据的自定义逻辑，如：处理和导出 Span 数据到不同的后端存储或平台，实时生成Agent执行轨迹等。</p>
<h4 id="_6">使用方式</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aworld.trace.span_cosumer</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpanConsumer</span><span class="p">,</span> <span class="n">register_span_consumer</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aworld.trace.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Span</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="nd">@register_span_consumer</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">MySpanConsumer</span><span class="p">(</span><span class="n">SpanConsumer</span><span class="p">):</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spans</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Span</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>        <span class="c1"># Process the spans</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>        <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">spans</span><span class="p">:</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Span processed: </span><span class="si">{</span><span class="n">span</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="instrumentation">Instrumentation（插桩）</h3>
<p>Instrumentation 是自动追踪框架核心组件的机制，通过字节码增强或装饰器的方式，无需修改代码即可实现对核心组件的追踪。AWorld中实现了对以下组件的插桩：</p>
<ul>
<li>EventBusInstrumentor（默认开启）：AWorld内部的消息总线插桩，使Trace能自动为Event执行创建Span，并跟踪Event的父子关系，Event A的处理逻辑中发出了Event B，则Event A的Span是Event B的Span的父Span。</li>
<li>AgentInstrumentor（默认开启）: AWorld内部Agent基类插桩，使Trace能自动为Agent执行创建Span，而无需侵入Agent核心代码。</li>
<li>ToolInstrumentor（默认开启）：AWorld内部工具基类插桩，使Trace能自动为工具执行创建Span，而无需侵入工具核心代码。</li>
<li>LLMModelInstrumentor（默认开启）：AWorld内部大模型调用插桩，使Trace能自动为每次LLM调用创建Span，而无需侵入调用核心代码。</li>
<li>ThreadingInstrumentor（默认开启）：对threading库的插桩，使Trace上下文可以在不同线程之间传播，这在多线程执行模式上非常重要。</li>
<li>FastAPIInstrumentor：对fastapi库的插桩，适用于在构建在FastAPI之上的web服务的Trace追踪，启用后可以为每次请求的执行创建Span。</li>
<li>FlaskInstrumentor：对flask库的插桩，适用于在构建在flask之上的web服务的Trace追踪，启用后可以为每次请求的执行创建Span。</li>
<li>RequestsInstrumentor：对requests库的插桩，适用于对外部服务的调用的Trace追踪，启用后可以为每次对外请求创建Span。</li>
</ul>
<h4 id="_7">启用方式</h4>
<p>以FastAPIInstrumentor为例：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aworld.trace.instrumentation.fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPIInstrumentor</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">FastAPIInstrumentor</span><span class="p">()</span><span class="o">.</span><span class="n">instrument</span><span class="p">()</span>
</span></code></pre></div>
<h2 id="_8">集成三方观测平台</h2>
<p>AWorld默认是基于OpenTelemetry构建的Trace追踪能力，收益于OpenTelemetry的数据传输协议<font style="color:rgb(51, 51, 51);">OTLP的广泛使用，且已成为Trace数据传输协议的事实标准，AWorld可以与广泛的三方观测平台集成，实现Trace数据的可视化展示和分析。</font></p>
<h3 id="_9"><font style="color:rgb(51, 51, 51);">使用三方商用平台</font></h3>
<h4 id="logfire">使用 Logfire</h4>
<p>Pydantic Logfire(<a href="https://logfire.pydantic.dev/docs/">https://logfire.pydantic.dev</a>)由Pydantic Validation背后的团队打造，是一种新型的可观测性平台。</p>
<p>要集成 Logfire，您只需要2步：</p>
<ol>
<li>到Logfire平台中创建项目，申请Write Token，请参阅Logfire官方文档：<a href="https://logfire.pydantic.dev/docs/">https://logfire.pydantic.dev/docs/</a>，生产环境建议购买付费计划。</li>
<li>AWorld应用启动时，配置相应的 Trace Provider 和后端：</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aworld.trace.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">configure</span><span class="p">,</span> <span class="n">ObservabilityConfig</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1"># 配置 Logfire 集成</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">config</span> <span class="o">=</span> <span class="n">ObservabilityConfig</span><span class="p">(</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="n">trace_provider</span><span class="o">=</span><span class="s2">&quot;otlp&quot;</span><span class="p">,</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="n">trace_backends</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;logfire&quot;</span><span class="p">],</span>  <span class="c1"># 使用 Logfire 作为后端</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="n">trace_base_url</span><span class="o">=</span><span class="s2">&quot;https://logfire-us.pydantic.dev&quot;</span><span class="p">,</span>  <span class="c1"># Logfire API URL</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>    <span class="n">trace_write_token</span><span class="o">=</span><span class="s2">&quot;your-logfire-write-token&quot;</span>  <span class="c1"># Logfire 写入令牌</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="p">)</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="c1"># 应用配置</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="_10">使用三方开源平台</h3>
<h4 id="jaeger">使用 Jaeger</h4>
<p>Jaeger （<a href="https://www.jaegertracing.io/">https://www.jaegertracing.io/</a>）是一个分布式追踪平台，由Uber Technologies于 2016 年以开源形式发布，并捐赠给了云原生计算基金会，它是该基金会的毕业项目。</p>
<p>使用Jaeger这样的开源库作为后端观测平台，需要用户自己搭建平台服务，运维成本与难度相对较大。Jaeger后端平台搭建请参阅官方文档：<a href="https://www.jaegertracing.io/docs/2.13/deployment/">https://www.jaegertracing.io/docs/2.13/deployment/</a></p>
<p>AWorld应用启动时，配置相应的 Trace Provider 和后端：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aworld.trace.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">configure</span><span class="p">,</span> <span class="n">ObservabilityConfig</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="c1"># 配置 Jaeger 集成</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="n">config</span> <span class="o">=</span> <span class="n">ObservabilityConfig</span><span class="p">(</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="n">trace_provider</span><span class="o">=</span><span class="s2">&quot;otlp&quot;</span><span class="p">,</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="n">trace_backends</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;other_otlp&quot;</span><span class="p">],</span>  <span class="c1"># 使用自定义 OTLP 后端</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="n">trace_base_url</span><span class="o">=</span><span class="s2">&quot;http://localhost:4317&quot;</span><span class="p">,</span>  <span class="c1"># Jaeger OTLP 接收器地址</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="n">trace_write_token</span><span class="o">=</span><span class="kc">None</span>  <span class="c1"># Jaeger 通常不需要令牌</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="p">)</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="c1"># 应用配置</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="trace_2">如何自定义 Trace 记录</h2>
<h3 id="span_1">使用上下文管理器创建 Span</h3>
<p>您可以使用 TraceManager 的 span 方法创建自定义 Span：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">aworld.trace</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">trace</span> 
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="k">with</span> <span class="n">trace</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="s2">&quot;custom_operation&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;custom_attr&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">}):</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="c1"># 执行需要追踪的操作</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">perform_custom_operation</span><span class="p">()</span>
</span></code></pre></div>
<h3 id="span_2">装饰器方式创建 Span</h3>
<p>您可以使用 func_span 装饰器为函数创建追踪 Span：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">aworld.trace</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">trace</span> 
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="c1"># 使用装饰器创建 Span</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="nd">@trace</span><span class="o">.</span><span class="n">func_span</span><span class="p">(</span><span class="s2">&quot;custom_function&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;function_type&quot;</span><span class="p">:</span> <span class="s2">&quot;business&quot;</span><span class="p">},</span><span class="n">extract_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">custom_function</span><span class="p">(</span><span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">):</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    <span class="c1"># 函数实现</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    <span class="k">return</span> <span class="n">result</span>
</span></code></pre></div>
<p>其中extract_args参数用于控制是否抽取函数参数列表，写入Span属性中，默认值为False。</p>
<h3 id="span_3">获取当前 Span 并添加属性</h3>
<p>您可以获取当前活动的 Span 并添加自定义属性：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">aworld.trace</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">trace</span> 
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="c1"># 获取当前 Span</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="n">current_span</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_current_span</span><span class="p">()</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="c1"># 添加自定义属性</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">current_span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;custom_key&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_value&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="span_4">手动管理 Span 生命周期</h3>
<p>您也可以手动管理 Span 的生命周期：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">aworld.trace</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">trace</span> 
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1"># 创建 Span</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="n">span</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="s2">&quot;manual_operation&quot;</span><span class="p">)</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="c1"># 执行需要追踪的操作</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">perform_operation</span><span class="p">()</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="c1"># 设置 Span 状态为成功</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    <span class="n">span</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">)</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="k">finally</span><span class="p">:</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>    <span class="c1"># 结束 Span</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>    <span class="n">span</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
</span></code></pre></div>
<h2 id="_11">高级功能</h2>
<h3 id="_12">自动追踪配置</h3>
<p>您可以配置自动追踪以打开函数调用的自动追踪功能，开启后，每一个函数调用都会自动创建一个Span。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">aworld.trace</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">trace</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="c1"># 配置自动追踪</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">trace</span><span class="o">.</span><span class="n">auto_tracing</span><span class="p">(</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;my_module&quot;</span><span class="p">,</span> <span class="s2">&quot;another_module&quot;</span><span class="p">],</span>  <span class="c1"># 要追踪的模块</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">min_duration</span><span class="o">=</span><span class="mf">0.1</span>  <span class="c1"># 最小持续时间（秒），只有超过此时间的函数才会被追踪</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="p">)</span>
</span></code></pre></div>
<h3 id="trace_3">Trace命名空间隔离</h3>
<p>您可能使用AWorld构建了多个不同的应用，不同应用的Trace数据使用不同的命名空间进行隔离。您可以通过环境变量来指令Trace命名空间。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MONITOR_SERVICE_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;otlp_example&quot;</span>
</span></code></pre></div>
<h3 id="trace_4">集成其他Trace传播协议</h3>
<p>AWorld Trace 模块内部默认使用Opentelemetry的W3C传播协议，当使用其他Trace传播协议的应用与AWorld应用交互时，由于协议不一致，trace就无法跨应用传播。为此，AWorld Trace 支持通过自定义传播协议实现不同系统间的追踪上下文传递。传播协议负责在服务间或应用间传递 TraceContext 信息，确保追踪链路的连续性。例如，AWorld支持与Sofa应用的Trace无缝传播，您也可以通过实现自定义传播协议，实现AWorld应用与使用Zipkin做Trace追踪的应用互通Trace上下文。</p>
<p><img alt="画板" src="../../../imgs/trace.png" /></p>
<h4 id="_13">核心概念</h4>
<ul>
<li>Propagator ：传播器接口，定义了从载体提取和注入追踪上下文的方法</li>
<li>TraceContext ：追踪上下文，包含 trace_id、span_id、版本等核心信息</li>
<li>Carrier ：载体，用于存储和传输追踪上下文的媒介（如 HTTP 头、消息头）</li>
</ul>
<h4 id="_14">传播协议集成架构</h4>
<p>AWorld 使用 CompositePropagator 实现多协议支持，其架构如下：</p>
<p><img alt="画板" src="../../../imgs/trace_propagator.png" /></p>
<h4 id="_15">实现自定义传播协议</h4>
<p>1、继承 Propagator 抽象类</p>
<p>要实现自定义传播协议，首先需要继承 Propagator 抽象类并实现 extract 和 inject 方法：</p>
<ul>
<li>extract：当一个请求从其他传播协议（如：Zipkin B3 传播协议）的应用进入AWorld应用时，根据B3协议抽取请求上下文中的Trace信息（trace_id, span_id, baggage等）。</li>
<li>inject：当一个请求从AWorld应用发送到其他传播协议应用时，将trace信息按目标应用的trace传播协议写入请求上下文中。</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aworld.trace.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Propagator</span><span class="p">,</span> <span class="n">TraceContext</span><span class="p">,</span> <span class="n">Carrier</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aworld.logs.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomTracePropagator</span><span class="p">(</span><span class="n">Propagator</span><span class="p">):</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="sd">    自定义 Trace 传播协议实现</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>    <span class="c1"># 定义协议头名称</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="n">_CUSTOM_TRACE_ID_HEADER</span> <span class="o">=</span> <span class="s2">&quot;X-Custom-Trace-ID&quot;</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="n">_CUSTOM_SPAN_ID_HEADER</span> <span class="o">=</span> <span class="s2">&quot;X-Custom-Span-ID&quot;</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>    <span class="n">_CUSTOM_FLAGS_HEADER</span> <span class="o">=</span> <span class="s2">&quot;X-Custom-Flags&quot;</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">Carrier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceContext</span><span class="p">]:</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="sd">        从载体中提取自定义追踪上下文</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>        <span class="c1"># 获取自定义协议头</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>        <span class="n">trace_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CUSTOM_TRACE_ID_HEADER</span><span class="p">)</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>        <span class="n">span_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CUSTOM_SPAN_ID_HEADER</span><span class="p">)</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>        <span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CUSTOM_FLAGS_HEADER</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;01&quot;</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extract custom trace context: trace_id=</span><span class="si">{</span><span class="n">trace_id</span><span class="si">}</span><span class="s2">, span_id=</span><span class="si">{</span><span class="n">span_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>        <span class="c1"># 验证必要参数</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">trace_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">span_id</span><span class="p">:</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>        <span class="c1"># 创建并返回 TraceContext</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>        <span class="k">return</span> <span class="n">TraceContext</span><span class="p">(</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>            <span class="n">trace_id</span><span class="o">=</span><span class="n">trace_id</span><span class="p">,</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>            <span class="n">span_id</span><span class="o">=</span><span class="n">span_id</span><span class="p">,</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>            <span class="n">trace_flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>            <span class="n">version</span><span class="o">=</span><span class="s2">&quot;00&quot;</span><span class="p">,</span>  <span class="c1"># 自定义版本号</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>                <span class="s2">&quot;custom_protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;v1&quot;</span><span class="p">,</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>                <span class="c1"># 可以添加更多自定义属性</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>            <span class="p">}</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>        <span class="p">)</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">inject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace_context</span><span class="p">:</span> <span class="n">TraceContext</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">Carrier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a><span class="sd">        将追踪上下文注入到载体中</span>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">trace_context</span><span class="p">:</span>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>            <span class="k">return</span>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inject custom trace context: trace_id=</span><span class="si">{</span><span class="n">trace_context</span><span class="o">.</span><span class="n">trace_id</span><span class="si">}</span><span class="s2">, span_id=</span><span class="si">{</span><span class="n">trace_context</span><span class="o">.</span><span class="n">span_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>        <span class="c1"># 注入自定义协议头</span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a>        <span class="n">carrier</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_CUSTOM_TRACE_ID_HEADER</span><span class="p">,</span> <span class="n">trace_context</span><span class="o">.</span><span class="n">trace_id</span><span class="p">)</span>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a>        <span class="n">carrier</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_CUSTOM_SPAN_ID_HEADER</span><span class="p">,</span> <span class="n">trace_context</span><span class="o">.</span><span class="n">span_id</span><span class="p">)</span>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a>        <span class="n">carrier</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_CUSTOM_FLAGS_HEADER</span><span class="p">,</span> <span class="n">trace_context</span><span class="o">.</span><span class="n">trace_flags</span><span class="p">)</span>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a>        <span class="c1"># 可以注入更多自定义属性</span>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a>        <span class="k">if</span> <span class="s2">&quot;custom_protocol&quot;</span> <span class="ow">in</span> <span class="n">trace_context</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
</span><span id="__span-11-57"><a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a>            <span class="n">carrier</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;X-Custom-Protocol-Version&quot;</span><span class="p">,</span> <span class="n">trace_context</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;custom_protocol&quot;</span><span class="p">])</span>
</span></code></pre></div>
<p>2、注册自定义传播器</p>
<p>实现自定义传播器后，需要将其注册到全局传播器中：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aworld.trace.propagator</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_global_trace_propagator</span><span class="p">,</span> <span class="n">CompositePropagator</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">my_custom_propagator</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomTracePropagator</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># 获取当前全局传播器</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">global_propagator</span> <span class="o">=</span> <span class="n">get_global_trace_propagator</span><span class="p">()</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="c1"># 获取现有传播器列表</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">global_propagator</span><span class="p">,</span> <span class="n">CompositePropagator</span><span class="p">):</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="n">existing_propagators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">global_propagator</span><span class="o">.</span><span class="n">_propagators</span><span class="p">)</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>    <span class="n">existing_propagators</span> <span class="o">=</span> <span class="p">[</span><span class="n">global_propagator</span><span class="p">]</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="c1"># 添加自定义传播器</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="n">existing_propagators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CustomTracePropagator</span><span class="p">())</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="c1"># 创建新的复合传播器</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="n">new_composite_propagator</span> <span class="o">=</span> <span class="n">CompositePropagator</span><span class="p">(</span><span class="n">existing_propagators</span><span class="p">)</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="c1"># 替换全局传播器</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aworld.trace.propagator</span><span class="w"> </span><span class="kn">import</span> <span class="n">_GLOBAL_TRACE_PROPAGATOR</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="n">_GLOBAL_TRACE_PROPAGATOR</span> <span class="o">=</span> <span class="n">new_composite_propagator</span>
</span></code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © Copyright 2025 inclusionAI AWorld Team.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "toc.follow", "content.code.copy", "content.code.annotate", "content.action.edit", "header.autohide"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../../js/hide-home-edit.js"></script>
      
        <script src="../../../js/aworld-enhancements.js"></script>
      
        <script src="../../../js/github-stars.js"></script>
      
        <script src="../../../js/github-stats-fallback.js"></script>
      
    
  </body>
</html>